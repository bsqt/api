---
kind: Project
name: bsqt
defaultEnvironment: local
environments:
  - name: local
    providers:
      - name: local-kubernetes
        context: microk8s
        namespace: local
        defaultHostname: local.app.garden
variables:
  domain: local.app.garden
  commit-hash: ${local.env.CI_COMMIT_SHA || "local"}
  commit-message: ${local.env.CI_COMMIT_MESSAGE || "local"}

---
kind: Module
type: helm
name: api
chartPath: charts/api
build:
  dependencies:
    - api-image
serviceResource:
  kind: Deployment
  containerModule: api-image
  hotReloadArgs:
    - --reload
values:
  image:
    repository: docker.bsqt.io/bsqt/api
    tag: ${modules.api-image.version}
  ingress:
    enabled: true
    hosts:
      - host: api.${var.domain}
        path: /

---
kind: Module
type: container
name: api-image
image: docker.bsqt.io/bsqt/api
buildArgs:
  COMMIT_HASH: ${var.commit-hash}
  COMMIT_MESSAGE: ${var.commit-message}
hotReload:
  sync:
    - target: /app/api
      source: ./api