---
kind: Project
name: bsqt-api
environments:
  - name: local
    providers:
      - name: local-kubernetes
        context: microk8s
        namespace: local
        defaultHostname: local.app.garden
variables:
  domain: local.app.garden
  commit-hash: ${local.env.CI_COMMIT_SHA || "local"}
  commit-message: ${local.env.CI_COMMIT_MESSAGE || "local"}

---
kind: Module
type: container
name: bsqt-api-image
image: docker.bsqt.io/bsqt/api
buildArgs:
  COMMIT_HASH: ${var.commit-hash}
  COMMIT_MESSAGE: ${var.commit-message}
hotReload:
  sync:
    - source: ./api
      target: /app/api/
services:
  - name: api
    args:
      - gunicorn
      - api.__main__:app
      - --bind=0.0.0.0:8000
      - --worker-class=sanic.worker.GunicornWorker
    hotReloadArgs:
      - gunicorn
      - api.__main__:app
      - --bind=0.0.0.0:8000
      - --worker-class=sanic.worker.GunicornWorker
      - --reload
    ports:
      - name: http
        containerPort: 8000
    ingresses:
      - path: /
        port: http
        hostname: api.${var.domain}
